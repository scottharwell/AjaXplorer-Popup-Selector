<?xml version="1.0" encoding="UTF-8"?>
<ajxp_plugin name="popupchooser" enabled="true" label="Popup Window Plugin" description="Extends external select for popup windows" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="file:../core.ajaxplorer/ajxp_registry.xsd">
	<dependencies>
		<pluginResources pluginName="gui.ajax"/>
		<!-- Stream Wrapper Access -->
		<activePlugin pluginName="access.AJXP_STREAM_PROVIDER"/>		
	</dependencies>
	<registry_contributions>
		<actions>
			<!-- Override the ext_select action -->
			<action name="ext_select">
				<processing>
					<clientCallback><![CDATA[
							var userSelection = ajaxplorer.getUserSelection();
							if((userSelection.isUnique() && !userSelection.hasDir()))
							{
								var fileName = userSelection.getUniqueFileName();
								var selectorData = ajaxplorer.actionBar.selectorData;
								if(selectorData.get('type') == "ckeditor"){
									var ckData = selectorData.get('data');
									if (ckData['CKEditorFuncNum']) {
										var imagePath = fileName;
										if(ckData['relative_path']){
											imagePath = ckData['relative_path'] + fileName;
										}
										window.opener.CKEDITOR.tools.callFunction(ckData['CKEditorFuncNum'], imagePath);
										window.close();
									}
								}
								else if(selectorData.get('type') == "popup"){
									var tmData = selectorData.get('data');
									
									var filePath = fileName;
									if(tmData.relative_path){
										filePath = tmData.relative_path + fileName;
									}
									
									if(window.console) console.log(tmData.filetypes);
									if(typeof(tmData.filetypes) !== "undefined"){
										var fileTypesArr = tmData.filetypes.match(/([a-zA-Z])+/g);
										
										var match = false;
										
										for(var i = 0; i < fileTypesArr.length; i++){
											if(fileName.match(fileTypesArr[i])){
												match = true;
											}
										}
										
										if(match){
											window.opener.ajaxplorerPopupCallback(filePath);
											window.close();
										} else {
											modal.displayMessage('ERROR', 'You did not select a valid file type');
											//alert('You did not select a valid file type');
										}
									} else {
										window.opener.ajaxplorerPopupCallback(filePath);
										window.close();
									}
								}
							}
						]]></clientCallback>
				</processing>
			</action>
			<action name="logout" expireDefault="false">
				<pre_processing>
					<clientCallback><![CDATA[
						return false;
					]]></clientCallback>
				</pre_processing>
			</action>	
		</actions>
	</registry_contributions>
</ajxp_plugin>